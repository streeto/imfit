\documentclass[10pt,a4paper,article]{memoir}

\usepackage[T1]{fontenc}

\usepackage[lf]{MinionPro}
\usepackage{MnSymbol}
% specify Inconsolata for tt (including verbatim environment)
%\usepackage{inconsolata}

% microtypography package -- mainly so we can firmly turn off ligatures for tt font
% (otherwise we sometimes get "--" --> en-dash, which we don't want in command-line
% and code examples!
\usepackage[expansion=false]{microtype}
\DisableLigatures{encoding = T1, family = tt* }


% Palatino options:
% specify "sc" option to get true small caps, not scaled-down regular caps
%\usepackage[sc]{mathpazo}
% the following works find (and has slightly nicer Greek letters than mathpazo),
% but doesn't let you use true small caps:
%\usepackage{mathpple}

% Note: the following warnings may not be true anymore (2013); at least, mathpple works
% FOLLOWING DOES NOT WORK [URW Garamond NOT INSTALLED?]
%\usepackage[garamond]{mathdesign}
% FOLLOWING DOES NOT WORK [SOME METRIC FILES ARE MISSING]
%\usepackage[]{mathtime}
% FOLLOWING DOES NOT WORK [EULER FONTS NOT INSTALLED?]
%\usepackage[]{mathpple}


% current Small Caps policy: things that are 3+ characters *and* that are like
% names: thus, GNU, GCC, FITS, MINPACK; but CPU and PSF are not "names", and thus remains
% as full caps.

%\usepackage{amssymb}

\usepackage{natbib}
\usepackage{hyperref}
\usepackage{color}

%\usepackage{fancyhdr}
%\pagestyle{fancy}
%\lhead{\textsc{Imfit Howto}}
%\chead{}

\usepackage{listings}
\lstset{language=C}

% Document layout and typography
\setlength{\oddsidemargin}{1.0cm}
\setlength{\textwidth}{13.5cm}
% increase leading to 1.1 * (1.2 * type size)
%    --> 1.07 * 1.2 * 10pt = 12.8 pt
\linespread{1.07}

\newcommand{\imfit}{\texttt{imfit}}
\newcommand{\Imfit}{\texttt{Imfit}}
\newcommand{\makeimage}{\texttt{makeimage}}
\newcommand{\Makeimage}{\texttt{Makeimage}}

\newcommand{\arcdeg}{\ensuremath{^{\circ}}}
\newcommand{\chisquare}{\ensuremath{\chi^{2}}}

\newcommand{\red}{\textcolor{red}}



\begin{document}

% Definition of title page:
\title{
  Notes for Using ``Imfit''
}
\author{
  Peter Erwin\\
  MPE and USM\\
  \href{mailto:erwin@sigmaxi.net}{erwin@sigmaxi.net}
}
\date{\today}  % optional

\maketitle

\tableofcontents


\chapter{What Is It?}

\Imfit{} is a program for fitting astronomical images --- 
specifically, for fitting images of galaxies, though it could certainly
be used for fitting other sources. The user specifies a set of one or
more 2D surface-brightness functions (e.g., elliptical exponential, elliptical S\'ersic,
circular Gaussian) which will be added together in order to generate a
model image; this model image will then be matched to the input image by
adjusting the 2D function parameters via nonlinear minimization of the total
\chisquare{} (or of the total Cash statistic in the alternate case of pure Poisson
statistics).

The 2D functions can be grouped into arbitrary sets sharing a common $(x,y)$
position on the image plane; this allows galaxies with off-center components
or multiple galaxies to be fit simultaneously. Parameters for the individual
functions can be held fixed or restricted to user-specified ranges. The
model image can (optionally) be convolved with a point spread
function (PSF) image to better match the input image; the PSF image can
be any square, centered image the user supplies -- e.g., an analytic 2D Gaussian
or Moffat, a \textit{Hubble Space Telescope} PSF generated by the TinyTim
program\footnote{\url{http://www.stsci.edu/hst/observatory/focus/TinyTim}} \citep{krist95}, 
or an actual stellar image.

A key part of \imfit{} is a modular, object-oriented design that allows easy
addition of new, user-specified 2D image functions. This is accomplished by
writing C++ code for a new image-function class (this can be done by copying and
modifying an existing pair of \texttt{.h/.cpp} files for one of the pre-supplied
image functions), making small modifications to two additional files to include
references to the new function, and re-compiling the program.

%Notes are [WILL BE] provided
%to guide the interested user in adding new functions; in most cases, a
%basic working knowledge of C should suffice.

An additional auxiliary program called \makeimage{}, built from the same
codebase, exists for generating artificial galaxy images (using the same
input/output parameter-file format as \imfit{}).

\Imfit{} is an open-source project; the source code is freely available
under the \textsc{gnu} Public License (\textsc{gpl}).


\bigskip

\textbf{System Requirements:} \Imfit{} has been built and tested on
Intel-based MacOS X 10.6--10.8 (Snow Leopard, Lion, and Mountain Lion)
and Linux (Ubuntu) systems. It uses standard C++ and should work on any
Unix-style system with a modern C++ compiler and the Standard Template
Library (e.g., \textsc{gcc} v4 or higher\footnote{\textsc{gcc} v4.2 or
higher is necessary to take advantage of OpenMP-related speedups.}). It
relies on two external, open-source libraries: version 3 of the
\textsc{cfitsio} library\footnote{\url{http://heasarc.nasa.gov/fitsio/}}
for \textsc{fits} image I/O and version 3 of the \textsc{fftw} (Fastest
Fourier Transform in the West)
library\footnote{\url{http://www.fftw.org/}} for PSF convolution. Some
optional components require the \textsc{gnu} Scientific Library
(\textsc{gsl}),\footnote{\url{http://www.gnu.org/s/gsl/}} and the NLopt
library\footnote{\url{http://ab-initio.mit.edu/wiki/index.php/NLopt}},
but the program can also be built without these.

\bigskip

\Imfit{} also includes modified versions of Craig Markwardt's
\texttt{mpfit} code (an enhanced version of the \textsc{minpack-1}
Levernberg-Marquardt least-squares fitting code) and the Differential
Evolution fitting code of Rainer Storn and Kenneth Price (more
specifically, a C++ wrapper written by Lester E. Godwin).



\chapter{Getting and Installing \Imfit{}}

\section{Pre-Compiled Binaries}

Pre-built binaries for Intel-based MacOS X and Linux systems, along with the
source code, are available at
\url{http://www.mpe.mpg.de/~erwin/code/imfit/}. The pre-compiled binaries included
statically linked versions of the \textsc{cfitsio}, \textsc{fftw}, \textsc{gsl}, and NLopt libraries, so you do
not need to have those installed.


\section{Building \Imfit{} from Source: Outline}

\begin{enumerate}
\item Install the \textsc{cfitsio} library (version 3.0 or higher).

\item Install the \textsc{fftw} library (version 3.0 or higher) --- note that if you have a
multi-core CPU (or multiple CPUs sharing main memory), you should
install the threaded version of \textsc{fftw} as well, since this speeds up PSF
convolution.

\item (Optional) Install the NLopt library --- this is only necessary if you
wish to use the Nelder-Mead minimization algorithm. \Imfit{} can easily be built
without this, if for some reason you don't have access to the NLopt library.

\item (Optional) Install the \textsc{gnu} Scientific Library
(\textsc{gsl}) --- this is only necessary if you wish to use image
functions that rely on \textsc{gsl}.  Currently, the only such functions
are the EdgeOnDisk component, which uses a modified Bessell function,
and the sample 3D line-of-sight integration functions (e.g.,
ExponentialDisk3D). \Imfit{} can easily be built without these
components, if for some reason you don't have access to the \textsc{gsl}.

\item Install SCons (if needed; see below).

\item Build \imfit{} and \makeimage.

\item (Optional) Run test scripts \texttt{do\_imfit\_tests} and \texttt{do\_makeimage\_tests}.

\end{enumerate}

\section{Building \Imfit{} from Source: Details}\label{sec:build}

Assuming that \textsc{cfitsio} and \textsc{fftw} (and optionally NLopt and \textsc{gsl}) have already been installed
on your system, unpack the source-code tarball (imfit-x.x-source.tar.gz) in some convenient
location.

\subsubsection{Building with SCons}

By default, \imfit{} uses SCons for the build process. SCons is a Python-based build system
that is somewhat easier to use and more flexible than the traditional \texttt{make}
system; it can be downloaded from \url{http://www.scons.org/}.

If things are simple, you should be able to build \imfit{} and the companion
program \makeimage{} with the following commands:
\begin{quote}
\texttt{\$ scons imfit} \\
\texttt{\$ scons makeimage}
\end{quote}
This will produce two binary executable files: \imfit{} and \makeimage{}. Copy
these to some convenient place on your path.

If you do not have \textsc{gsl} installed, you will get compilation errors; use the following
commands instead:
\begin{quote}
\verb+$ scons --no-gsl imfit+ \\
\verb+$ scons --no-gsl makeimage+
\end{quote}

Similarly, you will get compilation errors if you do not have the NLopt library installed;
this can be dealt with by using:
\begin{quote}
\verb+$ scons --no-nlopt imfit+ \\
\verb+$ scons --no-nlopt makeimage+
\end{quote}

Various other compilation options may be useful; these are explained in the next
subsections (note that all the SCons options can be combined on the command
line).


%\subsubsection{Alternative: Building with Make}
%
%As an alternative to using SCons, a preliminary version of a configure script and Makefile are
%included; you can use them to build \imfit{} and \makeimage{} via
%\begin{quote}
%\texttt{\$ ./configure} \\
%\texttt{\$ make all}
%\end{quote}
%The configure script will check for the presence of the various required and optional
%libraries in standard locations; if it cannot find the \textsc{gsl} or NLopt libraries, then
%compilation will be done without them (see below for specifying the path to the libraries
%manually).
%
%As in the case of using SCons, this will produce two binary executable
%files: \imfit{} and \makeimage{}. Copy these to some convenient place on
%your path.

\subsubsection{Tests}

Finally, there are two shell scripts -- \texttt{do\_imfit\_tests} and
\texttt{do\_makeimage\_tests} -- which can be run to do some very simple sanity
checks (e.g., do the programs fit some simple images correctly, are common
config-file errors caught, etc.). They make use of files and data in the
\texttt{tests/} subdirectory. Possible differences in output at the level of the
least significant digit may occur; these are not a problem. (For the full set of
tests to run, you should have Python version 2.6 or 2.7 installed, along with
the numpy\footnote{\url{http://numpy.scipy.org/}} and
pyfits\footnote{\url{http://www.stsci.edu/institute/software_hardware/pyfits}}
Python libraries. If these are not available, then the parts of the tests which
compare output images with reference versions will simply be skipped.)


%\subsubsection{Recommended Option: Compiling with OpenMP Support}
%
%\Imfit{} and \makeimage{} can be compiled to take advantage of OpenMP compiler support,
%which speeds up image computation by splitting it up across multiple CPUs
%(and multiple cores within multi-core CPUs).
%Currently, the code uses OpenMP 2.5 options, which means that if you are using
%the \textsc{gcc} compiler, you need version 4.2 or higher.
%
%To include OpenMP support, compile using the following options:
%\begin{quote}
%\texttt{\$ scons --openmp imfit} \\
%\texttt{\$ scons --openmp makeimage}
%\end{quote}


\subsubsection{Telling the Compiler Where to Find Header Files and Libraries}

By default, the SConstruct file (the equivalent of a Makefile for SCons)
tells SCons to look for header files in \texttt{/usr/local/include} and
library files in \texttt{/usr/local/lib}. If you have the \textsc{fftw},
\textsc{cfitsio}, and (optionally) NLopt and \textsc{gsl} headers and
libraries installed somewhere else, you can tell SCons about this by
using the
\texttt{--header-path} and \texttt{--lib-path} options:
\begin{quote}
\texttt{\$ scons --header-path=/some/path ...} \\
\texttt{\$ scons --lib-path=/some/other/path ...}
\end{quote}
(note that "\texttt{...}" is meant to stand for the rest of the compilation command,
whatever that may be).

Multiple paths can be specified if they are separated by colons, e.g.
\begin{quote}
\texttt{\$ scons --lib-path=/some/path:/some/other/path ...} \\
\end{quote}

%If you are using \texttt{configure + make} instead of SCons, you can specify the
%paths to the relevant header and library files via:
%\begin{quote}
%./configure CPPFLAGS=-I/the/location/include LDFLAGS=-L/the/location/lib
%\end{quote}


\subsubsection{Options: Compiling Without OpenMP Support}

By default, \imfit{} and \makeimage{} are compiled to take advantage of
OpenMP compiler support, which speeds up image computation by splitting
it up across multiple CPUs (and multiple cores within multi-core CPUs).
Currently, the code uses OpenMP 2.5 options, which means that if you are
using the \textsc{gcc} compiler, you need version 4.2 or higher. If your compiler
does not support OpenMP -- or you want, for whatever reason, a version
that does not include OpenMP support, you can disable it by compiling
with the following commands:
\begin{quote}
\texttt{\$ scons --no-openmp imfit} \\
\texttt{\$ scons --no-openmp makeimage}
\end{quote}

%If you are using the \texttt{configure + make} approach instead, you can use the
%following when running \texttt{configure}:
%\begin{quote}
%\texttt{\$ ./configure --disable-openmp}
%\end{quote}


\subsubsection{Options: Compiling Without FFT Multithreading}

By default, \imfit{} and \makeimage{} are compiled to take advantage of multi-core CPUs (and other
shared-memory multiple-processor systems) when performing PSF convolutions by using the 
multithreaded version of the
\textsc{fftw} library. If you do not have (or cannot build) the multithreaded \textsc{fftw} library,
you can remove multithreaded FFT computation by compiling with the following commands:
\begin{quote}
\texttt{\$ scons --no-threading imfit} \\
\texttt{\$ scons --no-threading makeimage}
\end{quote}

%Or, with the \texttt{configure + make} approach:
%\begin{quote}
%\texttt{\$ ./configure --disable-threading}
%\end{quote}





\chapter{Trying It Out}

In the \texttt{examples/} directory are some sample galaxy images, masks, PSF images, and
configuration files. To give \imfit{} a quick spin (and check that it's working on your system), change to the
\texttt{examples/} directory and execute the following on the command line (assuming that
\imfit{} is now in your path):
\begin{quote}
\texttt{\$ imfit ic3478rss\_256.fits \texttt{-c} config\_sersic\_ic3478\_256.dat \texttt{--}sky=130.14}
\end{quote}

This converges to a fit in a few seconds or less (e.g., about 0.5 seconds on a 
2011 MacBook Pro with a 2.3 GHz Core i7 processor). In addition to being printed to
the screen, the final fit is saved in a file called \texttt{bestfit\_parameters\_imfit.dat}.

The preceding command told \imfit{} to fit using every pixel in the image and to estimate
the noise assuming an original (previously subtracted) sky level of 130.14, an A/D gain
of 1.0, and zero read noise (the latter two are default values). A better approach would be 
to include a mask (telling \imfit{}
to ignore, e.g., pixels occupied by bright stars) and to specify more accurate values
of the gain and read noise:
\begin{quote}
\$ imfit ~ ic3478rss\_256.fits ~ \texttt{-c} ~ config\_sersic\_ic3478\_256.dat ~ \texttt{--}mask ~ ic3478rss\_256\_mask.fits ~ \texttt{--}gain=4.725 \texttt{--}readnoise=4.3 ~ \texttt{--}sky=130.14
\end{quote}

If you want to see what the best-fitting model looks like, you can use the companion program \makeimage{}
on the output file:
\begin{quote}
\$ makeimage ~ bestfit\_parameters\_imfit.dat ~ \texttt{--}refimage ~ ic3478rss\_256.fits
\end{quote}
This will generate and save the model image in a file called \texttt{modelimage.fits}. (\Imfit{} itself 
can save the best-fitting model image at the end of the fitting process if
the \texttt{--save-model} option is used.)

%Note that you can specify a subset of an image, thus:
%\begin{quote}
%ic3478rss\_256.fits[45:150,200:310]
%\end{quote}
%This will fit columns 45--150 and rows 200--310 of the image (column and row numbering starts
%at 1); pixel coordinates in the configuration (and output) files will refer to locations within the
%\textit{full} image.

You can also fit the image using PSF convolution, by adding the ``\texttt{--psf}'' option and a
valid \textsc{fits} image for the PSF; the \texttt{examples/} directory contains a Moffat PSF image which
matches stars in the original image fairly well:
\begin{quote}
imfit ~ ic3478rss\_256.fits ~ \texttt{-c} ~ config\_sersic\_ic3478\_256.dat ~ \texttt{--}mask ~ ic3478rss\_256\_mask.fits ~ \texttt{--}gain=4.725 \texttt{--}readnoise=4.3 ~ \texttt{--}sky=130.14 ~ \texttt{--}psf ~ psf\_moffat\_51.fits
\end{quote}


The PSF image was generated using \makeimage{} and the configuration
file \\
\texttt{config\_makeimage\_moffat\_psf.dat}:
\begin{quote}
\texttt{makeimage -o psf\_moffat\_51.fits config\_makeimage\_moffat\_psf.dat}
\end{quote}




\chapter{Using \Imfit{}}\label{sec:using-imfit}

Basic use of \imfit{} from the command line looks like this:
\begin{quote}
  \texttt{\$ \imfit{} }  -c \textit{config-file} ~ \textit{input-image} ~ [options]
\end{quote}
where \textit{config-file} is the name of the configuration file
which describes the model (the combination of 2D functions, initial values
for parameters, and possible limits on parameter values) and \textit{input-image}
is the \textsc{fits} image we want to fit with the model.

The ``options'' are a set of command-line flags and options (use ``\imfit{} \texttt{-h}''
or ``\imfit{} \texttt{--help}'' to see the complete list). Options must be followed by
an appropriate value (e.g., a filename, an integer, a floating-point number); this can
be separated from the option by a space, or they can be connected with an equals sign.
In other words, both of the following are valid:
\begin{quote}
\imfit{} ~ \texttt{--}gain 2.5 \\
\imfit{} ~ \texttt{--}gain=2.5
\end{quote}
Note that \imfit{} does not follow the full \textsc{gnu} standard for
command-line options and flags (as implemented by, e.g., the \textsc{gnu}
\texttt{getopt} library): you cannot merge multiple one-character flags
into a single item (if ``\texttt{-a}'' and ``\texttt{-b}'' are flags,
``\texttt{-a -b}'' will work, but ``\texttt{-ab}'' will \textit{not}), and you
cannot merge a one-character option and its target
(``\texttt{-cfoo.dat}'' is \textit{not} a valid substitute for
``\texttt{-c foo.dat}'').


\section{Command-line Flags and Options}\label{sec:imfit-flags}

Some notable and useful command-line flags and options include:
\begin{itemize}
\item \texttt{-c, --config} \textit{config-file} --- the only \textit{required}
command-line option, which tells \imfit{} the name of the configuration file.
(Actually, if you don't supply this option, \imfit{} will look for a file
called ``imfit\_config.dat'', but it's best to explicitly specify your own
configuration files.)

\bigskip

\item \texttt{--psf} \textit{psf-image} --- specifies a \textsc{fits} image to be convolved
with the model image.

\bigskip

\item \texttt{--mask} \textit{mask-image} --- specifies a \textsc{fits} image which marks
bad pixels to be ignored in the fitting process. By default, zero values in
the mask indicate \textit{good} pixels, and positive values indicate bad pixels.
\item \texttt{--mask-zero-is-bad} --- indicates that zero values (actually,
any value $< 1.0$) in the mask correspond to \textit{bad} pixels, with values
$\geq 1.0$ being good pixels.

\bigskip

\item \texttt{--noise} \textit{noisemap-image} --- specifies a pre-existing noise
or error \textsc{fits} image to use in the \chisquare{} fitting process (by default, pixel values in the
noise map are assumed to be Gaussian sigma values).
\item \texttt{--errors-are-variances} --- indicates that pixel values in the noise
map are variances (sigma$^2$) instead of sigmas.
\item \texttt{--errors-are-weights} --- indicates that pixel values in the noise
map should be interpreted as weights, not as sigmas or variances. (None
of these three options are usable with Cash statistic minimization.)

\bigskip

\item \texttt{--sky} \textit{sky-level} --- specifies an original constant sky background
level (in counts/pixel) that was subtracted from the image; used for internal
computation of the noise map (for \chisquare{} minimization) or for correcting the 
Cash statistic computation. (If the pixel units are counts/sec, then the sky level
should also be in those units, and you should use the ``\texttt{--exptime}'' option
to specify the original exposure time.)
\item \texttt{--gain} \textit{value} --- specifies the A/D gain (in electrons/ADU)
of the input image; used for internal computation of the noise map for \chisquare{}
minimization.
\item \texttt{--readnoise} \textit{value} --- specifies the read noise (in electrons)
of the input image; used for internal computation of the noise map for \chisquare{}
minimization.
\item \texttt{--exptime} \textit{value} --- specifies the exposure time of the image;
this should \textbf{only} be used \textit{if} the image has been divided by the exposure time
(i.e., if the pixel units are counts/sec).
\item \texttt{--ncombined} \textit{value} --- if values in the input
image are the result of averaging (or computing the median of) two or
more original images, then this option should be used to specify the
number of original images; used for internal computation of the noise
map for \chisquare{} minimization.  If multiple images were
\textit{added} together with no rescaling, then do not use this option.

\bigskip

\item \texttt{--save-params} \textit{output-filename} --- specifies that parameters 
for best-fitting model should be saved using the specified filename (the default is
for these to be saved in a file named \texttt{bestfit\_parameters\_imfit.dat}).
\item \texttt{--save-model} \textit{output-filename} --- the best-fitting model image
will be saved using the specified filename.
\item \texttt{--save-residual} \textit{output-filename} --- the residual image (input
image $-$ best-fitting model image) will be saved using the specified filename.

\bigskip

\item \texttt{--nm} --- use Nelder-Mead simplex instead of Levenberg-Marquardt as
the minimization technique (\textsc{Warning}: slower)
\item \texttt{--de} --- use Differential Evolution instead of Levenberg-Marquardt as
the minimization technique (\textsc{Warning}: much slower!)

\bigskip

\item \texttt{--model-errors} --- use the model image pixel values
(instead of the data values) to estimate the individual-pixel dispersions
$\sigma_{i}$ for \chisquare{} minimization

\item \texttt{--cashstat} --- use Cash statistic instead of \chisquare{} as the fit
statistic for minimization; for use in the case of Poisson statistics and zero read
noise. Cannot be used with the (default) Levenberg-Marquardt minimization technique.

\item \texttt{--ftol} \textit{FTOL-value} --- specify tolerance for
fractional improvements in the fit statistic (\chisquare{} or Cash
statistic) value; if further iterations do not reduce the fit statistic
by more than this, the minimization is considered a success and halted 
(default value = $10^{-8}$)

\bigskip

\item \texttt{--bootstrap} \textit{n-iterations}--- Do \textit{n-iterations} rounds
of bootstrap resampling after the fit, to estimate parameter errors.

\bigskip

\item \texttt{--chisquare-only} --- Evaluate the \chisquare{} value for
the initial input model as a fit to the input image, \textit{without}
doing any minimization to find a better solution.

\bigskip

\item \texttt{--max-threads} \textit{n-threads} --- specifies the maximum number of CPU cores to use
during computation (the default is to use \textit{all} available CPU cores); has no
effect if \imfit{} was compiled without OpenMP or \textsc{fftw} multithreading support.

\bigskip

\item \texttt{--list-functions} --- list all the functions \imfit{} can use.

\item \texttt{--list-parameters} --- list all the individual parameters (in correct order)
for each of the functions that \imfit{} can use.
\end{itemize}




\chapter{The Configuration File}\label{sec:configfile}

\texttt{Imfit} always requires a configuration file, which specifies the model
which will be fit to the input image, initial values for model parameters, any
limits on parameter values (optional for fitting with the Levenberg-Marquardt
solver, but required for fitting with the Differential Evolution solver), and
possibly additional information (e.g, gain and read noise for the input image).

The configuration file should be a plain text file. Blank lines and
lines beginning with ``\#'' are ignored; in fact, anything on the same line after a
``\#'' is ignored, which allows for comments at the end of lines.

A model for an image is specified by one or more \textbf{function blocks}, each of
which is a group of one or more 2D image functions sharing a common $(x,y)$
spatial position. Each function-specification consists of a line beginning with
``FUNCTION'' and containing the function name, followed by one or more lines
with specifications for that function's parameters.

\bigskip

More formally, the format for a configuration file is:
\begin{enumerate}
\item Optional specifications of general parameters and settings (e.g., the
input image's A/D gain and read noise)
\item One or more function blocks, each of which contains:
\begin{enumerate}
\item X-position parameter-specification line
\item Y-position parameter-specification line
\item One or more function + parameters specifications, each of which contains:
\begin{enumerate}
\item \texttt{FUNCTION} + function-name line
\item one or more parameter-specification lines
\end{enumerate}
\end{enumerate}
\end{enumerate}

This probably sounds more complicated than it is in practice.
Here is a very bare-bones example of a configuration file:

\begin{quote}
  \texttt{X0  ~  150.1}\\
  \texttt{Y0  ~  149.5}\\
  \texttt{FUNCTION   Exponential}\\
  \texttt{PA  ~  95.0}\\
  \texttt{ell  ~  0.45}\\
  \texttt{I\_0 ~  90.0}\\
  \texttt{h   ~  15.0}\\
\end{quote}

This describes a model consisting of a single elliptical exponential
function, with initial values for the $x$ and $y$ position on the image,
the position angle (PA), the ellipticity (ell), the central intensity
(I\_0) in counts/pixel, and the exponential scale length in pixels (h).
None of the parameters have limits on their possible values.

Here is the same file, with some additional annotations and with limits on
some of the parameters (comments are colored red for clarity):

\begin{quote}
  \texttt{\red{\# This line is a comment}}\\
  
  \texttt{X0 ~~   150.1 ~  148,152}\\
  \texttt{Y0 ~~   149.5 ~  148,152         \red{\# a note}}\\
  \texttt{FUNCTION   Exponential  ~ \red{\# here is a comment}}\\
  \texttt{PA  ~  95.0  ~ 0,180   ~~   \red{\# limits on the position angle}}\\
  \texttt{ell  ~  0.45 ~ 0,1     ~~~ \red{\# ellipticity should always be 0--1}}\\
  \texttt{I\_0 ~  90.0 ~  fixed ~~~ \red{\# keep central intensity fixed}}\\
  \texttt{h    ~ 15.0}\\
\end{quote}

Here we can see the use of comments (lines or parts of lines beginning with
``\#'') and the use of parameter limits in the form of ``lower,upper'': the X0
and Y0 parameters are required to remain $\geq 148$ and $\leq 152$, the position
angle is limited to 0--180, the ellipticity must stay $\geq 0$ and $\leq 1$, and
the central intensity I\_0 is held fixed at its initial value.

Finally, here is a more elaborate example, specifying a model that has two
function blocks, with the first block having two individual functions (so this
could be a model for, e.g., simultaneously fitting two galaxies in the same
image, one as S\'ersic + exponential, the other with just an exponential):

\begin{quote}
  \texttt{\red{\# This line is a comment}}\\
  
  \texttt{GAIN  2.7   \red{\# A/D gain for image in e/ADU}}\\
  \texttt{READNOISE  4.5   \red{\# image read-noise in electrons}}\\
  
  \texttt{\red{\# This is the first function block: Sersic + exponential}}\\
  \texttt{X0 ~~   150.1  ~~ 148,152}\\
  \texttt{Y0 ~~   149.5  ~~ 148,152}\\
  \texttt{FUNCTION   Sersic   \red{\# A Sersic function}}\\
  \texttt{PA  ~  95.0  ~~ 0,180}\\
  \texttt{ell ~   0.05 ~ 0,1}\\
  \texttt{n   ~~   2.5  ~~~ 0.5,4.0 ~~ \red{\# Sersic index}}\\
  \texttt{I\_e ~  20.0 ~~ \red{\# intensity at the half-light radius}}\\
  \texttt{r\_e ~    5.0 ~~ \red{\# half-light radius in pixels}}\\
  \texttt{FUNCTION   Exponential}\\
  \texttt{PA   ~ 95.0  ~~ 0,180}\\
  \texttt{ell  ~  0.45  ~~0,1}\\
  \texttt{I\_0 ~  90.0  ~ fixed}\\
  \texttt{h    ~~ 15.0}\\
  
  \texttt{\red{\# This is the second function block: just a single exponential}}\\
  \texttt{X0 ~~   225.0  ~~ 224,226}\\
  \texttt{Y0 ~~   181.7  ~~ 180,183}\\
  \texttt{FUNCTION   Exponential} \\
  \texttt{PA   ~ 22.0  ~~ 0,180      }\\
  \texttt{ell  ~  0.25 ~ 0,1}\\
  \texttt{I\_0 ~  10.0  }\\
  \texttt{h   ~~~  20.0}\\
\end{quote}


\section{Parameter Names, Specifications, and Values}

The X0/Y0 position lines at the start of each function block and the
individual parameter lines for each function all share a common format:
\begin{quote}
\textit{parameter-name} ~~ \textit{initial-parameter-value} ~~ \textit{optional-limits}
\end{quote}
The separation between the individual pieces must consist of one or more spaces
and/or tabs. The final piece specifying the limits is optional (except that
fitting in Differential Evolution mode \textit{requires} that there be limits
for each parameter).

\bigskip

\textbf{Parameter Names:} The X0/Y0 positional parameters for each
function block must be labeled ``X0'' and ``Y0''. Names for the
parameters of individual functions can be anything the user desires;
only the order matters. Thus, the position-angle parameter could be
labeled ``PA'', ``PosAngle'', ``angle'', or any non-space-containing
string --- though it's a good idea to have it be something relevant
and understandable.

\textbf{Important Note:} \textit{Do not change the order of the parameters
for a particular function!}  Because the strings giving the parameter names
can be anything at all, \imfit{} actually ignores them and simply assumes
that all parameters are in the correct order for each function.

Note that any output which \imfit{} generates will use the default parameter
names defined in the individual function code (use ``\texttt{--list-parameters}''
to see what these are for each function).

\bigskip

\textbf{Values for Positional Parameter (X0, Y0)}: The positional parameters
for each function block are pixel values -- X0 for the column number and
Y0 for the row number. \Imfit{} uses the \textsc{iraf} pixel-numbering
convention: the center of first pixel in the image (the lower left pixel
in a standard display) is at $(1.0,1.0)$, with the lower-left corner of that
pixel having the coordinates $(0.5,0.5)$.

\bigskip

\textbf{General Parameter Values for Functions}: The meaning of the individual
parameter values for the various 2D image functions is set by the functions
themselves, but in general: 
\begin{itemize}
\item position angles are measured in degrees counter-clockwise
from the image's vertical ($+y$) axis (i.e., degrees E of N if the image has standard
astronomical orientation);
\item ellipticity $= 1 - b/a$, where $a$ and $b$ are the
semi-major and semi-minor axes of an ellipse;
\item intensities are in counts/pixel;
\item lengths are in pixels. 
\end{itemize}
If you write your own functions, you are encouraged
to stick to these conventions.

\section{Parameter Limits}\label{sec:param-limits}

Individual parameters can be limited in two ways:
\begin{enumerate}
\item Held fixed;
\item Bounded between lower and upper limits.
\end{enumerate}
To hold a parameter fixed, use the string ``fixed'' after the initial-value
specification. E.g.:
\begin{quote}
\texttt{X0} ~~ 442.85 ~~ fixed
\end{quote}
To specify lower and upper limits for a parameter, include them as a comma-separated
pair following the initial-value specification. E.g.:
\begin{quote}
\texttt{X0} ~~ 442.85 ~~ 441.0,443.5
\end{quote}


\section{Optional Image-Description Parameters}

The configuration file can, optionally, contain one or more specifications of 
parameters describing the whole image, which take the place of certain command-line
options for computing the internal noise map.  The specifications should be placed
at the beginning of the configuration file, \textit{before} the first function
block is described. The format is the same as for other parameters in the configuration
file: the name of the parameter, followed by one or more spaces and/or tabs, followed
by a numerical value. E.g.,
\begin{quote}
  \texttt{GAIN  2.7} \\
  \texttt{READNOISE  4.5} \\
\end{quote}

The currently available image-description parameters are (see Section~\ref{sec:imfit-flags} for more
details about the corresponding command-line options):
\begin{itemize}
\item GAIN -- same as command-line option \texttt{--gain} (A/D gain in electrons/ADU)
\item READNOISE -- same as command-line option \texttt{--readnoise} (read noise in electrons)
\item EXPTIME -- same as command-line option \texttt{--exptime}
\item NCOMBINED -- same as command-line option \texttt{--ncombined}
\item ORIGINAL\_SKY -- same as command-line option \texttt{--sky} (original
background level that was subtracted from the image)
\end{itemize}

In situations where a configuration file contains one of these specifications
and the corresponding command-line option is also used, \textit{the command-line option
always overrides whatever value is  in the configuration file.}



\chapter{Standard Image Functions}

\Imfit{} comes with the following 2D image functions, each of
which can be used as many times as desired. (As mentioned above, \imfit{}
is designed so that constructing and using new functions is a relatively
simple process.) Most of these functions use a specified radial intensity
profile (e.g., Gaussian, exponential, S{\'e}rsic) with elliptical isophote
shapes. Note that elliptical functions can always be made circular
by setting the ``ellipticity'' parameter to 0.0 and specifying that it be
held fixed. See Appendix~\ref{app:functions} for more complete discussions of all
functions, including their parameters.

\begin{itemize}
\item FlatSky --- a uniform sky background.
\item Gaussian --- an elliptical 2D Gaussian function.
\item Moffat --- an elliptical 2D Moffat function.
\item Exponential --- an elliptical 2D exponential function.
\item Exponential\_GenEllipse --- an elliptical 2D exponential function using
generalized ellipses (``boxy'' to ``disky'' shapes) for the isophote shapes.
\item Sersic --- an elliptical 2D S\'ersic function.
\item Sersic\_GenEllipse --- an elliptical 2D S\'ersic function using
generalized ellipses (``boxy'' to ``disky'' shapes) for the isophotes.
\item Core-Sersic --- an elliptical 2D Core-S\'ersic function \citep{graham03,trujillo04}.
\item BrokenExponential --- similar to Exponential, but with \textit{two}
exponential radial zones (with different scalelengths) joined by a transition region
at $R_{\mathrm{break}}$ of variable sharpness.
\item GaussianRing --- an elliptical ring with a radial profile
consisting of a Gaussian centered at $r = R_{\mathrm{ring}}$.
\item GaussianRing2Side --- like GaussianRing, but with a radial profile
consisting of an asymmetric Gaussian (different values of $\sigma$ for
$r < R_{\mathrm{ring}}$ and $r > R_{\mathrm{ring}}$).
\item EdgeOnDisk --- the analytical form for a perfectly edge-on exponential
disk, using the Bessel-function solution of \citet{vdk81} for 
the radial profile and the generalized sech function of \citet{vdk88} 
for the vertical profile. Note that this function requires that the \textsc{gnu}
Scientific Library (\textsc{gsl}) be installed; if the \textsc{gsl} is not installed, \imfit{}
should be compiled without this function (see Section~\ref{sec:build}).
\item EdgeOnRing --- a simplistic model for an edge-on ring, using a
Gaussian for the radial profile and another Gaussian (with
different $\sigma$) for the vertical profile.
\item EdgeOnRing2Side --- like EdgeOnRing, but using an
asymmetric Gaussian for the radial profile (see description of GaussianRing2Side).

\end{itemize}

In addition, three experimental ``3D'' functions are available. With these, the
intensity value for each pixel comes from line-of-sight
integration through a 3D luminosity-density model, generating a projected 2D
model image given input specifications of the orientation and inclination
to the line of sight. All of these require the \textsc{gsl} for compilation from source (see Section~\ref{sec:build}).
\begin{itemize}
\item ExponentialDisk3D --- uses a 3D luminosity-density model of an axisymmetric 
exponential disk (with different radial and vertical scale lengths), observed
at an arbitrary inclination, to generate a projected surface-brightness image.
\item BrokenExponentialDisk3D --- similar to ExponentialDisk3D, except that the
radial profile of the luminosity density is a broken exponential.
\item GaussianRing3D --- uses a 3D 
luminosity-density model of an elliptical ring with Gaussian radial and exponential 
vertical profiles.

\end{itemize}

A list of the currently available functions can always be obtained
by running \imfit{} with the ``\texttt{--list-functions}'' option:
\begin{quote}
  \texttt{\$ \imfit{} --list-functions}
\end{quote}
The complete list of function parameters for each function (suitable for copying
and pasting into a configuration file) can always be
obtained by running \imfit{} with the ``\texttt{--list-parameters}'' option:
\begin{quote}
  \texttt{\$ \imfit{} --list-paremeters}
\end{quote}




\chapter{Images}

\Imfit{} is designed to fit 2D astronomical images in \textsc{fits} format, where
pixel values are some form of linear surface-brightness (or surface
density) measurement. The default internal error calculations (see
Section~\ref{sec:noise-maps}, below) assume that pixel values are
integrated counts (e.g., ADUs), which can be converted to detected
photons using the $A/D$ gain (provided by ``\texttt{--gain}'' option, or
by the GAIN keyword in a configuration file). However, since \imfit{} can
also accept a user-supplied noise/error image in \textsc{fits} format, you can
use any linear pixel values as long as the corresponding noise image is
appropriately scaled to match.

If your image is in counts/second, you can either multiply it by the
exposure time to recover the integrated counts, or include the actual
exposure time via the ``\texttt{--exptime}'' option (or the EXPTIME keyword
in a configuration file).

If the image is an \textit{average} of $N$ input images of the same exposure time, you
can either multipy the image by $N$ \textit{or} use the ``\texttt{--ncombined}'' option
to tell \imfit{} how to adjust the error estimations.  The latter option is slightly
better, because \imfit{} will also scale the read noise accordingly.

\Imfit{} does \textit{not} assume the presence of any particular header
keywords in the \textsc{fits} file.




\section{Specifying Image Subsections, Compressed Images, etc.}

In many cases, you may want to fit an object which is much smaller than the whole
image. You can always make a smaller cutout image and fit that, but it may be convenient to
specify the image subsection directly. You can do this using a subset of the image-section
syntax of \textsc{cfitsio} (which will be familiar to you if you've ever worked with
image sections in \textsc{iraf}). An example:

\begin{quote}
ic3478rss\_256.fits[45:150,200:310]
\end{quote}
This will fit columns 45--150 and rows 200--310 of the image (column and row
numbering starts at~1). Pixel coordinates in the configuration (and output)
files refer to locations within the \textit{full} image.

The only kind of image section specification that's allowed is a simple
[x1:x2,y1:y2] format, though you can specify all of a particular dimension using
an asterisk (e.g., [*,y1:y2] to specify the full range of x values). More
complicated expressions which might extract part of a 3D datacube are not
(currently) possible. However, you \textit{can} specify a particular extension
(header-data unit) in a multi-extension \textsc{fits} file, e.g.:

\begin{quote}
ic3478rss.fits[2]

ic3478rss.fits[2][45:150,200:310]
\end{quote}

Obviously, if you are also using a mask image (and/or a noise image), you should
specify the same subsection in those images!

You can also use fit (or generate) images which have been compressed with gzip or
Unix compress -- e.g., \texttt{ic3478rss\_256.fits.gz}.
Images, masks, etc., can even be read via \texttt{http://} or \texttt{ftp://} URLs which point directly to
accessible \textsc{fits} files; you
cannot \textit{save} files to URLs, however.



\chapter{Extras for Fitting Images}

\section{Masks}

A mask image can be supplied to \imfit{} by using the command-line
option \texttt{--mask}. The mask image should be an \textit{integer}-valued
\textsc{fits} file with the same dimensions as the image being fitted (\textsc{iraf} \texttt{.pl}
mask files are not recognized, but these can be converted to \textsc{fits} format within
\textsc{iraf}). The default is to treat zero-valued pixels in the mask image as
\textit{good} and pixels with values $> 0$ as \textit{bad} (i.e., to be excluded
from the fit); however, you can specify that zero-valued pixels are \textit{bad}
with the command-line flag \texttt{--mask-zero-is-bad}.



\section{Noise, Variance, or Weight Maps}\label{sec:noise-maps}

By default, \imfit{} uses \chisquare{} as the statistic for
minimization. As part of this, \imfit{} normally calculates an internal
weight map, using the input pixel intensities, the A/D gain, any
previously subtracted background level, and the read noise to estimate
Gaussian errors $\sigma_{i}$ for each pixel $i$. The error-based weight
map is $w_{i} = 1/\sigma^{2}_{i}$, with the dispersion (in ADU) defined as
\begin{equation}
\sigma^{2}_{i} \; = \; (I_{d, i} + I_{\mathrm{sky}})/g_{\mathrm{eff}} \, + \, N_{\mathrm{c}} \, \sigma_{\mathrm{rdn}}^{2}/g_{\mathrm{eff}}^{2} \, ,
\end{equation}
where $I_{d, i}$ is the data intensity in counts/pixel, $I_{\mathrm{sky}}$ is
the original subtracted sky background (if any), $\sigma_{\mathrm{rdn}}$ is
the read noise (in electrons), $N_{\mathrm{c}}$ is the number of separate images combined
(averaged or median) to
form the data image, and $g_{\mathrm{eff}}$ is the ``effective gain'' (the
product of the $A/D$ gain,  $N_{\mathrm{c}}$, and optionally the exposure
time, if the image units are counts/pixel). As an alternative, the \textit{model}
intensity values $I_{m, i}$ can be used instead of $I_{d, i}$, by specifying
the \texttt{--model-errors} command-line flag. This is marginally slower (since
the weights must be recalculated every time the model image is updated), but
can lead to smaller biases in fitted parameters \citep[see][]{humphrey09,erwin13}.

The weights are then used
in the \chisquare{} calculation, summing over all $N$ pixels:
\begin{equation}
\chisquare \; = \; \sum_{i = 0}^{N} w_{i} \, (I_{m, i} - I_{d, i})^2 ,
\end{equation}
where $I_{m, i}$ and $I_{d, i}$ are the model and data intensities
in counts/pixel, respectively. (Masking is handled by setting $w_{i} = 0$
for masked pixels.)

If you have a pre-existing error map as a \textsc{fits} image, you can tell \imfit{} to
use that instead, via the \texttt{--noise} command-line option. By default, the
pixel values in this image are assumed to be errors $\sigma_{i}$ in units of
ADU/pixel. If the values are \textit{variances} ($\sigma_{i}^2$), you can specify
this with the \texttt{--errors-are-variances} flag. You can also tell \imfit{}
that the pixel values in the noise map are actual \textit{weights} $w_{i}$ via the
\texttt{--errors-are-weights} flag, if that happens to be the case. (If a mask
image is supplied, the weights of masked pixels will still be set to 0,
regardless of their individual values in the weight image.)

Note that \imfit{} does \textit{not} try to obtain information (such as
the A/D gain or read noise) from the \textsc{fits} header of an image. This is primarily
because there is little consistency in header names across the wide range of
astronomical images, so it is difficult pick one name, or even a small set, and
assume that it will be present in a given image's header; this is even more
true if an image is the result of a simulation.

If the user has specified the Cash statistic $C$ instead of \chisquare, the
minimization uses
\begin{equation}
C \; = \; \sum_{i = 0}^{N} w_{i} \, (I^{\prime}_{m, i} \, - \, I^{\prime}_{d, i} \ln I^{\prime}_{m, i}),
\end{equation}
where $I^{\prime}_{m, i}$ and $I^{\prime}_{d, i}$ are the model and data
intensities in counts/pixel, multiplied by the effective gain $g_{\mathrm{eff}}$ as defined above. In this case, all weights are automatically $=
1$, except for masked pixels, which are still set $= 0$.


\section{PSF Convolution}

To simulate the effects of seeing and other telescope resolution effects, model
images can be convolved with a PSF (point-spread function) image. This uses an
input \textsc{fits} file which contains the point spread function. The actual convolution
uses Fast Fourier Transforms of the interally-generated model image and the PSF
image to compute the output convolved model image.

PSF images should be square, ideally with width = an odd number of pixels, and
the PSF should be centered in the central pixel. (An off-center PSF can certainly
be used, but the resulting convolved model images will be shifted.) The PSF does
\textit{not} need to be normalized, as \imfit{} will automatically normalize the
PSF image internally.

Although \imfit{} uses a multi-threaded version version of the \textsc{fftw} library, which
is itself quite fast, adding PSF convolution to the image-fitting process \textit{does}
slow things down considerably.



\chapter{Minimization Options: Levenberg-Marquardt, Differential Evolution, Nelder-Mead Simplex}

The default method for \chisquare{} minimization  used by \imfit{} is the
Levenberg-Marquardt algorithm, based on the classic \textsc{minpack-1}
implementation with enhancements by Craig Markwardt.\footnote{Original C
version available at
\url{http://www.physics.wisc.edu/~craigm/idl/cmpfit.html}} This is very
fast and robust, and is the most extensively tested algorithm in \imfit,
but requires an initial guess for the parameter values and can sometimes
become trapped in local minima in the \chisquare{} landscape. In
addition, it is \textit{not} appropriate if one is using the Cash
statistic, since the latter can potentially have both per-pixel and total values
$< 0$, which the Levenberg-Marquardt algorithm cannot handle.

An alternative algorithm, available via the \texttt{--nm} flag,  is a
version of the Nelder-Mead simplex, as implemented by the NLopt
library.\footnote{\url{http://ab-initio.mit.edu/wiki/index.php/NLopt}}
This is significantly slower than Levenberg-Marquardt minimization
($\sim 10$ times slower for fits with one or two components), but
significantly faster than Differential Evolution (below). Like the
Levenberg-Marquardt method, it does require an initial guess for the
parameter values, but is considered less likely to become trapped in
local minima in the fit-statistic landscape. Unlike the L-M algorithm,
it can be used for both \chisquare{} and Cash-statistic minimization. If
you compile \imfit{} from source and want to use this algorithm, you
need to have the NLopt library installed on your system.

The second alternate algorithm is available via the \texttt{--de} flag.
This performs the fit-statistic (\chisquare{} or Cash statistic)
minimization using Differential Evolution (DE) \citep{de}, a
genetic-algorithms
approach.\footnote{\url{http://www.icsi.berkeley.edu/~storn/code.html}}
It has the drawback of being $\sim$ an order of magnitude slower than
the Nelder-Mead simplex method, and \textit{much} slower ($\sim$ two
orders of magnitude) than Levenberg-Marquardt minimization. For example,
fitting a single S\'ersic function to the $256 \times 256$ image in the
\texttt{examples/} subdirectory takes $\sim 60$ times as long when using
Differential Evolution as it does when using L-M minimization. It does
has the advantage of being the least likely (at least in principle) of
being trapped in local minima in the fit-statistic landscape; it also
does \textit{not} require an initial guess for the parameter values.

The Differential Evolution algorithm does, however, \textit{require} lower and upper
limits for \textit{all} parameters in the configuration file (see
Section~\ref{sec:param-limits}); this is because DE generates parameter-value
``genomes'' by random uniform sampling from within the ranges specified by the
parameter limits. The format of the configuration file still requires that
initial-guess values be present for all parameters as well, but these are
actually ignored by the DE algorithm. (This is to ensure that the same
configuration file can be used with all minimization routines.)


\medskip

TBD. [more details of DE implementation]

\medskip

Note that the N-M simplex and DE algorithms do \textit{not} produce uncertainty
estimates for the best-fitting parameter values, in contrast to the
Levenberg-Marquardt approach. However, the L-M error estimates are themselves
only reliable if the minimum in the \chisquare{} landscape is symmetric and
parabolic, and if the errors for the input image are truly Gaussian and
well-determined.  See Section~\ref{sec:bootstrap} for an alternative (and probably
more accurate) way of estimating the parameter uncertainties.

\medskip

The fact that the minimization algorithms are relatively decoupled from the rest
of the code means that future versions of \imfit{} could include
other minimization techniques, or that an ambitious user could add such techniques
on their own.


\section{Controlling the Tolerance for Minimization}

All three minimization algorithms have stop conditions based on
fractional changes in the fit-statistic (\chisquare{} or Cash statistic)
value: if further iterations do not improve the current value by more
than FTOL $\times$ the fit statistic, then the algorithm declares success and
terminates. (In the case of DE, the test condition is actually no
further improvement after 30 generations.) The default value of FTOL is
$10^{-8}$, which seems to do a reasonable job for typical images (in
fact, it's probably overkill). If you want to experiment with different
values of FTOL, you can do this via the command-line option
\texttt{--ftol}.

There are also built-in stopping conditions based on maximum number of
iterations for the L-M algorithm (1000), maximum number of generations for DE
(600), or maximum number of function evaluations (i.e., computations of model
images) for the Nelder-Mead simplex algorithm (10000 times the number of free
parameters).

TBD: info about extra stopping conditions for the L-M and N-M simplex algorithms


\chapter{Outputs}

\section{Main Outputs}

Assuming that the fitting process converges, \imfit{} will print a
summary of the results, including the final, best-fitting parameter
values. The output parameter list is in the same format as the
configuration file, except that if the L-M algorithm is used, its error
estimates are listed after each parameter value.\footnote{No in-line
error estimates are produced if the Nelder-Mead simplex or Differential
Evolution algorithms were used for the minimization.} These error
estimates are separated from the parameter values by ``\#''; this means
that you can copy and paste the parameter list into a text file and use
that file as an input configuration file for \imfit{} or \makeimage. 

The best-fitting parameters will also be written to an output text file (the default
name for this is \texttt{bestfit\_parameters\_imfit.dat}; use \texttt{--save-params} to
specify a different name), \textit{without} the error estimates. The output file
will also include a copy of the original command used to start \imfit{} and the
date and time it was generated; these are commented out so that the file can be
subsequently used as an \imfit{} or \makeimage{} configuration file without
modification.

The final value of the fit statistic (\chisquare{} or Cash statistic) is
also printed; if the fit statistic was \chisquare, then  the reduced
$\chi^{2}$ (which accounts for the total number of unmasked pixels and
non-fixed parameter values)\footnote{The reduced $\chi^{2}$ value should
be interpreted with caution; it is valid in absolute terms only if the
noise has been correctly estimated \textit{and} if all differences
between the model and the data are solely due to noise, which is rarely
true for galaxies and other astronomical objects.} is also printed.
Finally, two alternate measures of the fit are also printed: the Akaike
Information Criterion (\textsc{aic}) and the Bayesian Information Criterion
(\textsc{bic}). The latter two are included on a provisional basis; they are, in
principle, useful for comparing different models fit to the same data.

By default, no model or residual (image $-$ model) images are saved, but the
command-line options \texttt{--save-model} and \texttt{save-residual} can be used
to specify output names for those images, and corresponding \textsc{fits} files will be saved
to disk.

TBD.

\section{Uncertainties on Parameter Values: L-M Estimates vs.\ Bootstrap Resampling}
\label{sec:bootstrap}

The (default) Levenberg-Marquardt minimization algorithm used by
\imfit{} automatically generates a set of (symmetric) uncertainty
estimates for each  free parameter at the conclusion of the fitting
process; as noted above, these are printed to the terminal as part of
the summary output.

These values come from the covariance matrix derived from the final Jacobian
matrix corresponding to the best-fit solution, and should be viewed with caution: for
example, they assume that the \chisquare{} landscape in the vicinity of
the best-fit solution is parabolic XXX. In practice, they should probably be
seen as \textit{lower limits} on the uncertainty.

The other fitting algorithms used by \imfit{} do not compute gradients
in the fit landscape, and so they do not produce automatic uncertainty
estimates. Although one could certainly take the solution of a
\chisquare{} fit done with the N-M simplex or DE algorithms and use it as input to a
L-M run of \imfit, thus generating L-M--based uncertainties, this is not
possible when using the Cash statistic.

As an alternative to the somewhat dubious L-M uncertainty estimates --
and as a method for estimating uncertainties in the case of
Cash-statistic minimization -- \imfit{} offers the option of bootstrap
resampling. This is done with the ``\texttt{--bootstrap}'' command-line
option, which takes the \textit{number} of iterations as its
corresponding value; e.g. 
\begin{verbatim} imfit someimage.fits -c config.dat [. . .] --bootstrap 200 
\end{verbatim}

Each iteration of bootstrap resampling generates a new data image by
sampling pixel values (with replacement) from the original data image,
and then re-runs the fit to generate a new set of parameter
values.\footnote{To speed things up, the original best-fit parameters
are used as starting values for the new fit.} After $n$ iterations, the
combined set of bootstrapped parameter values can be used as a
distribution for estimating confidence intervals; \imfit{} finds and
outputs the 68.3\% confidence intervals and the standard deviation for
each parameter. While this approach is likely to produce more plausible
uncertainties for the best-fit parameters -- and can be used with both
\chisquare{} and Cash-statistic minimization and as an adjunct to any of
the three minimization algorithms -- it \textit{is} slow, as one is
essentially repeating (a somewhat faster version of) the fitting process
$n$ times. Ideally, one should do at least 200 iterations -- 1000 or
more is preferable -- to get reasonably consistent confidence intervals.
Since this can take \textit{much} longer than the original fitting
process, it is probably not a good idea to use bootstrap resampling when one is
engaged in exploratory fitting, but to instead postpone it until one is
reasonably certain one has the final fit. To keep things as fast
as possible, \imfit{} automatically chooses L-M minimization for the
bootstrap process -- unless the Cash statistic is being used, in which
case the N-M simplex method is used.

(Future versions of \imfit{} may include the option of dumping all bootstrapped
parameter values to a text file, to allow more detailed inspection of the
distributions.)

TBD.



\chapter{Makeimage}

\Imfit{} has a companion program called \makeimage, which will generate model
images using the same functions (and parameter files) as \imfit. In fact (as
noted above), the output ``best-fitting parameters'' file generated by \imfit{}
can be used as input to \makeimage, as can an \imfit{} configuration file.

\Makeimage{} \textit{does} require an output image size.  This can be specified
via command-line flags (``\texttt{--ncols}'' and ``\texttt{--nrows}''), via
specifications in the configuration file (see below), or by supplying a
reference \textsc{fits} image (``\texttt{--refimage} \textit{image-filename}''); in the
latter case, the output image will have the same dimensions as the reference
image.

\Makeimage{} can also be run in a special mode to estimate the
magnitudes and fractional luminosities of different components in a
model.


\section{Using \Makeimage{}}

Basic use of \makeimage{} from the command line looks like this:
\begin{quote}
  \texttt{\$ \makeimage{} }  [options] ~ \textit{config-file}
\end{quote}
where \textit{config-file} is the name of the \imfit{}-style configuration file
which describes the model.

As for \imfit, the ``options'' are a set of command-line flags and
options (use ``\makeimage{} \texttt{-h}'' or ``\makeimage{} \texttt{--help}'' to
see the complete list). Options must be followed by an appropriate value
(e.g., a filename, an integer, a floating-point number); this can be
separated from the option by a space, or they can be connected with an
equals sign.

\bigskip

Some notable and useful command-line flags and options include:
\begin{itemize}
\item \texttt{-o, --output} \textit{filename} --- filename for the output model
image (default = ``modelimage.fits'').

\item \texttt{--refimage} \textit{filename} --- existing reference image to
use for determining output image dimensions.

\item \texttt{--ncols} \textit{N\_columns} --- number of columns in output image

\item \texttt{--nrows} \textit{N\_rows} --- number of rows in output image

\bigskip

\item \texttt{--psf} \textit{psf-image} --- specifies a \textsc{fits} image to be convolved
with the model image.

\bigskip


\item \texttt{--nosave} --- do \textit{not} save the model image (useful for testing
purposes, or when estimating fluxes with \makeimage)

\bigskip

\item \texttt{--list-functions} --- list all the functions \makeimage{}
can use

\item \texttt{--list-parameters} --- list all the individual parameters (in correct order)
for each functions that \makeimage{} can use


\end{itemize}



\section{Configuration Files for \Makeimage{}}

The configuration file for \makeimage{} has essentially the same format as
that for \imfit; any parameter limits that might be present are ignored.

Optional general parameters like GAIN and READNOISE are ignored, but the
following optional general parameters are available:

\begin{itemize}
\item NCOLS --- number of columns for the output image (x-size)

\item NROWS --- number of rows for the output image (y-size)

\end{itemize}




\section{Generating Single-Function Output Images}

\Makeimage{} can also output individual images for each function
in the configuration file. For example, if the configuration file specifies
a model with one S\'ersic function and two exponential functions, \makeimage{}
can generate three separate \textsc{fits} files, in addition to the (standard) sum of
all three functions.  This is done with the \texttt{--output-functions} option:
\begin{quote}
  \texttt{--output-functions} ~ \textit{root-name}
\end{quote}
where \textit{root-name} is a string that all output single-function filenames will
start with. The single-function filenames will be sequentially numbered (starting
with 1) according to the order of functions in the configuration file, and the
name of each function will added to the end; the resulting filenames will have
this format:
\begin{quote}
  \textit{root-name}{N}\texttt{\_}\textit{function-name}\texttt{.fits}
\end{quote}

Using the example specified above (a model with one S\'ersic and two exponential
functions), one could execute the following command
\begin{quote}
  \texttt{\$ \makeimage} ~ \textit{config-file} ~ \texttt{--output-functions mod}
\end{quote}
and the result would be three \textsc{fits} files, named \texttt{mod1\_Sersic.fits},
\texttt{mod2\_Exponential.fits}, and \texttt{mod3\_Exponential.fits} (in addition
to \texttt{model.fits}, which is the sum of all three functions).


\section{Using \Makeimage{} to Estimate Fluxes and Magnitudes}

Given a configuration file, you can use \makeimage{} to estimate the total
fluxes and magnitudes of different model components. For some components --
e.g., the purely elliptical versions of the Gaussian, Exponential, and Sersic
functions -- there are analytical expressions which could be used. But since
\imfit{} and \makeimage{} are designed to use arbitrary functions, including
ones which do not have analytical expressions for total flux, \makeimage{}
estimates the flux for each component by internally constructing a large model
image for each component function in the configuration file, with the
component centered within this image, and then summing the pixel values of that image. The
output includes a list of total and relative fluxes for each component in the
model image (and their magnitudes, if a zero point is supplied).


\begin{quote}
  \texttt{\$ \makeimage{} }  --print-fluxes ~ \textit{config-file}
\end{quote}

Useful command-line flags and options:
\begin{itemize}

\item \texttt{--estimation-size} \textit{N\_columns\_and\_rows} --- size of the
(square) image to construct (the default size is 5000 pixels on a side)

\item \texttt{--zero-point} \textit{value} --- zero point for converting total counts
to magnitudes:
\begin{equation}
m \; = \; Z - 2.5 \log_{10}( {\mathrm{counts}} )
\end{equation}

\end{itemize}

This enables you to compute things like bulge/total ratios -- but it's up to you
to determine which component(s) should be considered ``bulge'', ``disk'', etc.

When run in this mode, \makeimage{} will still produce an output image file --
unless you also specify the \texttt{--nosave} option.




\chapter{Rolling Your Own Functions}

\section{Basic Requirements}

A new image function should be implemented in C++ as a subclass of
the FunctionObject base class (\texttt{function\_object.h}, \texttt{function\_object.cpp}).
At a minimum, it should provide its own implementation of the following public methods,
which are defined as virtual methods in the base class:
\begin{itemize}
\item The class constructor --- in most cases the code for this can be copied from any of the
existing FunctionObject subclasses, unless some special extra initialization is needed.
\item Setup() --- this is used by the calling program to supply the current set of
function parameters (including the $(x_{0},y_{0})$ pixel values for the center) prior
to determining intensity values for individual pixels. This
is a convenient place to do any general calculations which don't depend on the
exact pixel $(x,y)$ values.
\item GetValue() --- this is used by the calling program to obtain the surface
brightness for a given pixel location $(x,y)$. In existing FunctionObject classes,
this method often calls other (private) methods to handle details of the calculation.
\item GetClassShortName() -- this is a class function which is used to obtain
the short version of the class name as a string.

\end{itemize}

The new class should also redefine the following internal class constants:
\begin{itemize}
\item \texttt{N\_PARAMS} --- the number of input parameters (\textit{excluding} the
central pixel coordinates);
\item \texttt{PARAM\_LABELS} --- an array of string labels for the input parameters;
\item \texttt{FUNCTION\_NAME} --- a short string describing the function;
\item \texttt{className} --- a string (no spaces allowed) giving the official name
of the function.
\end{itemize}

The \texttt{add\_functions.cpp} file should then be updated by:
\begin{enumerate}
\item including the header file for the new class;
%\item adding the class short name as a string to the \texttt{FUNCTION\_NAMES} array;
%\item incrementing the \texttt{N\_FUNCTIONS} constant;
\item adding 2 lines to the PopulateFactoryMap() function to add the ability to create an instance of
the new class.
\end{enumerate}

Finally, the name of the C++ implementation file for the new class should be added
to the \texttt{Sconstruct} file to ensure it gets included in the compilation.

Existing examples of FunctionObject subclasses can be found in the ``\texttt{function\_objects}''
subdirectory of the source-code distribution, and are the best place to look in order
to get a better sense of how to implement new FunctionObject subclasses.


\section{A Simple Example}

To illustrate, we'll make a new version of the Moffat function (which already
exists, so this is purely for pedagogical purposes) by copying and modifying the
code for the Gaussian function.

\bigskip

We need to make three sets of changes:
\begin{itemize}
\item Change the class name from ``Gaussian'' to our new name (``NewMoffat'');
\item Change the relevant code which computes the function;
\item Rename, add, or delete variables to accomodate the new algorithm.
\end{itemize}


\subsubsection{Create and Edit the Header File}

Change directory to the directory with the \imfit{} source code, and then
to the subdirectory named ``\texttt{function\_objects}''. Copy the file
\texttt{func\_gaussian.h} and rename it to \texttt{func\_new-moffat.h}. Edit
this file and change the following lines:

\begin{verbatim}
#define CLASS_SHORT_NAME  "Gaussian"
\end{verbatim} 
(replace \texttt{"Gaussian"} with \texttt{"NewMoffat"})

\begin{verbatim}
class Gaussian : public FunctionObject
\end{verbatim}
(replace \texttt{Gaussian} with \texttt{NewMoffat})

\begin{verbatim}
    Gaussian( );
\end{verbatim}
(replace \texttt{Gaussian} with \texttt{NewMoffat})

And finally edit the list of class data members, changing this:
\begin{verbatim}
  private:
    double  x0, y0, PA, ell, I_0, sigma;   // parameters
    double  q, PA_rad, cosPA, sinPA;   // other useful (shape-related) quantities
\end{verbatim}
to this:
\begin{verbatim}
  private:
    double  x0, y0, PA, ell, I_0, fwhm, beta;   // parameters
    double  alpha;
    double  q, PA_rad, cosPA, sinPA;   // other useful (shape-related) quantities
\end{verbatim}


\subsubsection{Create and Edit the Class File}

Copy the file \texttt{func\_gaussian.cpp} and rename it to \texttt{func\_new-moffat.cpp}. 

\bigskip
\noindent \textit{Initial changes, including parameter number and names:}
\smallskip

Edit this file and change the following lines (changed text indicated in red):

\begin{quote}
\texttt{\#include "\red{func\_new-moffat.h}"} \\

const int  N\_PARAMS = \red{5}; \\

const char  PARAM\_LABELS[][20] = \{"PA", "ell", "I\_0", \red{"fwhm", "beta"}\}; \\

const char  FUNCTION\_NAME[] = "\red{Moffat} function";

\end{quote}

\bigskip
\noindent \textit{Change references to class name:}
\smallskip

Change all class references from ``Gaussian'' to ``NewMoffat'' (e.g., \texttt{Gaussian::Setup}
becomes \texttt{NewMoffat::Setup}).

\bigskip
\noindent \textit{Changes to Setup method:}
\smallskip

In the Setup method, you need to change how the input is converted into
parameters, and do any useful pre-computations. So the initial processing of
the ``params'' input changes from this:
\begin{verbatim}
  PA = params[0 + offsetIndex];
  ell = params[1 + offsetIndex];
  I_0 = params[2 + offsetIndex];
  sigma = params[3 + offsetIndex];
\end{verbatim}

to this:
\begin{verbatim}
  PA = params[0 + offsetIndex];
  ell = params[1 + offsetIndex];
  I_0 = params[2 + offsetIndex];
  fwhm = params[3 + offsetIndex];
  beta = params[4 + offsetIndex];
\end{verbatim}
and at the end we replace this:
\begin{verbatim}
  twosigma_squared = 2.0 * sigma*sigma;
\end{verbatim}
with this:
\begin{verbatim}
  // compute alpha:
  double  exponent = pow(2.0, 1.0/beta);
  alpha = 0.5*fwhm/sqrt(exponent - 1.0);
\end{verbatim}


\bigskip
\noindent \textit{Changes to CalculateIntensity method:}
\smallskip

Although it is the public method GetValue() which is called by other parts of
the program, we don't actually need to change the current version of that method
in this simple example. The code in the original Gaussian version of GetValue()
just converts pixel positions to a scaled radius value, given input values for
the center, ellipticity, and position angle, and then calls the private method
CalculateIntensity() to determine the intensity as a function of the radius.
Since we're still assuming a perfectly elliptical shape, we can keep the
existing code.  It probably doesn't make sense to change the CalculateSubsamples
method, either, so we can leave that alone.

Instead, we actually implement the details of the new function's algorithm in
CalculateIntensity(). Replace the original version of this method with the
following:

\begin{verbatim}
double NewMoffat::CalculateIntensity( double r )
{
  double  scaledR, denominator;
  
  scaledR = r / alpha;
  denominator = pow((1.0 + scaledR*scaledR), beta);
  return (I_0 / denominator);
}
\end{verbatim}

\bigskip

%In this simple example, we aren't changing the isophote geometry (i.e.,
%we're still assuming a perfectly elliptical shape), so we don't need to
%change the GetValue method, which converts pixel position to a scaled
%radius value.  It probably doesn't make sense to change the
%CalculateSubsamples method, either, so we can leave that alone.

At this point, most of the work is done.  We only need to update
\texttt{add\_functions.cpp} so it knows about the new function and
update the SConstruct file so that the new function is included in the
compilation.


\subsubsection{Edit add\_functions.cpp}

We need to do two simple things here:
\begin{enumerate}
\item Include the header file for our new function. Add the following line near
the top of the file, where the other header files are included:\\
\texttt{\#include "func\_new-moffat.h"}

\item Add code to generate an instance of our new class as part of the
function-factory map. Inside the function PopulateFactoryMap, add the following lines:
\begin{verbatim}
  NewMoffat::GetClassShortName(classFuncName);
  input_factory_map[classFuncName] = new funcobj_factory<NewMoffat>();
\end{verbatim}

\end{enumerate}



\subsubsection{Edit the SConstruct File}

In the SConstruct file, locate the place where the variable
``functionobject\_obj\_string'' is defined (currently somewhere near line 280,
though this may change in the future). This is a string containing a
compact list of all the filenames containing function-object code. Insert our
new function's name (``func\_new-moffat'') into the list.

\bigskip

That's it! You should now be able to recompile \imfit{} and \makeimage{} 
(see Section~\ref{sec:build}) to use
the new function. (Assuming there aren't any bugs in your new code\ldots.)



\chapter{Acknowledging Use of \Imfit}

A paper describing \imfit{} is currently in preparation; until it is available, you can
reference the current URL (\url{http://www.mpe.mpg.de/~erwin/code/imfit/}) if \imfit{} has
been useful in your research.


\newpage

\appendix
\chapter{Standard Functions in Detail}\label{app:functions}

Unless otherwise noted, all ``intensity'' parameters (\texttt{I\_sky},
\texttt{I\_0}, \texttt{I\_e}, etc.) are in units of counts per pixel, and all
lengths are in pixels.

A sample function specification (giving the parameters in their proper order),
as you would use in a configuration file, is listed for each function
description.

``Elliptical'' functions are defined to have an intensity which is constant on
concentric, similar ellipses (with specified ellipticity and major-axis position angle);
the intensity profile is defined as a function of the semi-major axis $a$.


\section{2D Functions}

The main set of image functions provided create 2D intensity distributions
directly. These include most of the usual suspects used in 2D image fitting:
constant background, Gaussian, exponential, S{\'e}rsic, etc.

\medskip

\textbf{Common parameters}: 
\begin{itemize}
\item \texttt{PA} = position angle (e.g., of the major axis), measured in degrees CCW from
the image +y axis. This is equivalent to standard astronomical position angles \textit{if}
your image has standard astronomical orientation (N up, E to the left).
\item \texttt{ell} = ellipticity ($1 - b/a$, where $a$ and $b$ are semi-major and semi-minor
axes of the ellipse, respectively).
\end{itemize}


\subsubsection{FlatSky}

A uniform background: $I(x,y) = I_{\mathrm{sky}}$ everywhere.

\begin{verbatim}
FUNCTION FlatSky
I_sky
\end{verbatim}


\subsubsection{Gaussian}

This is an elliptical 2D Gaussian function, with the major-axis intensity
profile given by
\begin{equation}
I(a) \, = \, I_{0} \exp(-a^2/(2 \sigma^2)).
\end{equation}

\begin{verbatim}
FUNCTION Gaussian
PA
ell
I_0
sigma
\end{verbatim}


\subsubsection{Moffat}

This is an elliptical 2D Moffat function, with the major-axis intensity profile
given by
\begin{equation}
I(a) \, = \, \frac{I_{0}  }{(1 + (a/\alpha)^{2})^{\beta} },
\end{equation}
where $\alpha$ is defined as
\begin{equation}
\alpha \, = \, \frac{ {\mathrm{FWHM}}}{2 \sqrt{2^{1/\beta} - 1}}.
\end{equation}
In practice, FWHM describes the overall width of the profile, while $\beta$ describes that
strength of the wings: lower values of $\beta$ mean more intensity in the wings
than is the case for a Gaussian (as $\beta \rightarrow \infty$, the Moffat profile
approaches a Gaussian).

The Moffat function is often a good approximation to typical telescope PSFs (see, e.g.,
\citealt{trujillo01}), and \makeimage{} can easily be used to generate Moffat PSF images.

\begin{verbatim}
FUNCTION Moffat
PA
ell
I_0
fwhm
beta
\end{verbatim}


%  double  exponent = pow(2.0, 1.0/beta);
%  alpha = 0.5*fwhm/sqrt(exponent - 1.0);
%  q = 1.0 - ell;
%
%  scaledR = r / alpha;
%  denominator = pow((1.0 + scaledR*scaledR), beta);
%  return (I_0 / denominator);


\subsubsection{Exponential}

This is an elliptical 2D exponential function, with the major-axis intensity
profile given by
\begin{equation}
I(a) \, = \, I_{0} \exp(-a/h),
\end{equation}
where $I_{0}$ is the central surface brightness and $h$ is the scale length.

\begin{verbatim}
FUNCTION Exponential
PA
ell
I_0
h
\end{verbatim}


\subsubsection{Exponential\_GenEllipse}

Similar to the Exponential function, but using generalized ellipses (``boxy'' to
``disky'' shapes) instead of pure ellipses for the isophote shapes.  Following
\citet{athanassoula90}, the shape of the elliptical isophotes is controlled by
the \texttt{c0} parameter, such that a generalized ellipse with ellipticity $= 1
- b/a$ is described by
\begin{equation}
%\left( \frac{|x|}{a}^{c_{0} + 2} \right) + \left( \frac{|y|}{b}^{c_{0} + 2} \right) \; = \; 1,
\left( \frac{|x|}{a} \right)^{c_{0} + 2} \! \! + \; \left( \frac{|y|}{b} \right)^{c_{0} + 2}  = \; 1,
\end{equation}
where $|x|$ and $|y|$ are distances from the ellipse center in the coordinate system
aligned with the ellipse major axis ($c_{0}$ corresponds to $c - 2$ in the original
formulation of Athanassoula et al).
Thus, values of $c_{0} < 0$ correspond to disky isophotes, while values $> 0$ describe boxy
isophotes; $c_{0} = 0$ corresponds to a perfect ellipse.

\begin{verbatim}
FUNCTION Exponential_GenEllipse
PA
ell
c0
I_0
h
\end{verbatim}


\subsubsection{Sersic}

This is an elliptical 2D S\'ersic function with the major-axis intensity
profile given by
\begin{equation}
I(a) \; = \; I_{e} \: \exp \left\{ -b_{n} \left[ \left( \frac{a}{r_{e}} \right)^{1/n} \! - \: 1 \right] \right\},
\end{equation}
where $I_{e}$ is the surface brightness at the effective (half-light) radius $r_{e}$
and $n$ is the S\'ersic index controlling the shape of the intensity profile. The
value of $b_{n}$ is formally given by the solution to the transcendental equation
\begin{equation}
\Gamma(2 n) \; = \; 2 \gamma(2n, b_{n}),
\end{equation}
where $\Gamma(a)$ is the gamma function and $\gamma(a, x)$ is the incomplete gamma function.
However, in the current implementation $b_{n}$ is calculated via the polynomial approximation
of \citet{ciotti99} when $n > 0.36$ and the approximation of \citet{macarthur03} when
$n \leq 0.36$.

Note that the S\'ersic function is equivalent to the de Vaucouleurs ``$r^{1/4}$'' profile
when $n = 4$, to an exponential when $n = 1$, and to a Gaussian when $n = 0.5$.

\begin{verbatim}
FUNCTION Sersic
PA
ell
n
I_e
r_e
\end{verbatim}


\subsubsection{Sersic\_GenEllipse}

Similar to the Sersic function, but using generalized ellipses (``boxy'' to
``disky'' shapes) instead of pure ellipses for the isophote shapes.  See the
discussion of the \texttt{Exponential\_GenEllipse} function above for details of the isophote
shapes.

\begin{verbatim}
FUNCTION Sersic_GenEllipse
PA
ell
c0
n
I_e
r_e
\end{verbatim}



\subsubsection{Core-Sersic}

This generates an elliptical 2D function with the major-axis intensity profile
given by the Core-S{\'e}rsic model \citep{graham03,trujillo04}. This has a
S\'ersic profile (parameterized by $n$ and $r_{e}$) for radii $>$ the break
radius $r_{b}$ and a single power law with index $-\gamma$ for radii $< r_{b}$.
The transition between the two regimes is mediated by the parameter $\alpha$:
for low values of $\alpha$, the transition is very gradual and smooth, while for
high values of $\alpha$ the transition becomes very abrupt (a perfectly sharp
transition can be approximated by setting $\alpha =$
some large number such as 100). The overall intensity scaling is set by $I_{b}$,
the intensity at the break radius $r_{b}$.

\begin{verbatim}
FUNCTION Core-Sersic
PA
ell
n
I_b
r_e
r_b
alpha
gamma
\end{verbatim}



%\subsubsection{FlatExponential} 
%
%Similar to Exponential, but with an inner radial zone ($a < r_{\rm break}$)
%of constant surface brightness $I_{0}$.
%
%\begin{verbatim}
%FUNCTION FlatExponential
%PA
%ell
%I_0
%h
%r_break
%alpha
%\end{verbatim}


\subsubsection{BrokenExponential}

Similar to Exponential, but with \textit{two}
exponential radial zones (with different scalelengths) joined by a transition region
at $R_{b}$ of variable sharpness:
\begin{equation}
	I(a) \; = \; S \, I_{0} \, e^{-\frac{a}{h_{1}}} [1 + e^{\alpha(a \, - \,
	R_{b})}]^{\frac{1}{\alpha} (\frac{1}{h_{1}} \, - \, \frac{1}{h_{2}})},
\end{equation}
where $I_{0}$ is the central intensity of the inner exponential, $h_{1}$ and
$h_{2}$ are the inner and outer exponential scale lengths, $R_{b}$ is the break radius, and
$\alpha$ parameterizes the sharpness of the break.  (See \citet{erwin08}.) Low values of $\alpha$
mean very smooth, gradual breaks, while high values correspond to abrupt
transitions.  $S$ is a scaling factor, given by
\begin{equation}
  S \; = \; (1 + e^{-\alpha R_{b}})^{\frac{1}{\alpha} (\frac{1}{h_{1}} \, - 
  \, \frac{1}{h_{2}})}.
\end{equation}

Note that the parameter $\alpha$ has units of length$^{-1}$ (i.e., pixels$^{-1}$).

\begin{verbatim}
FUNCTION BrokenExponential
PA
ell
I_0
h1
h2
r_break
alpha
\end{verbatim}


\subsubsection{GaussianRing}

An elliptical ring with a radial profile consisting of a Gaussian
centered at $r = R_{\mathrm{ring}}$.

\begin{verbatim}
FUNCTION GaussianRing
PA
ell
A
R_ring
sigma_r
\end{verbatim}


\subsubsection{GaussianRing2Side}

Similar to GaussianRing, but now using an asymmetric Gaussian (different
values of $\sigma$ for $r < R_{\mathrm{ring}}$ and $r > R_{\mathrm{ring}}$).

\begin{verbatim}
FUNCTION GaussianRing2Side
PA
ell
A
R_ring
sigma_r_in
sigma_r_out
\end{verbatim}


\subsubsection{EdgeOnDisk}

This function provides the analytical form for a perfectly edge-on disk with a
radial exponential profile, using the Bessel-function solution of \citet{vdk81}
for the radial profile and the generalized sech function of \citet{vdk88} for
the vertical profile.\footnote{This model was used by \citet{yoachim06} for 2D
modeling of thin and thick disks in edge-on galaxies, though typically with $n$
fixed to values of 1 or 2.} The position angle parameter (PA) describes the
angle of the disk major axis; there is no ellipticity parameter.

In a coordinate system aligned with the edge-on disk, $r$ is the distance from the minor
axis (parallel to the major axis) and $z$ is the perpendicular direction, with $z = 0$
on the major axis. (The latter corresponds to height $z$ from the galaxy midplane.) The 
intensity at $(r,z)$ is given by
\begin{equation}
I(r,z) \; = \; \mu(0,0) \; (r/h) \; K_{1}(r/h) \;\, {\mathrm{sech}}^{2/n} (n \, z/(2 \, z_{0}))
\end{equation}
where $h$ is the exponential scale length in the disk plane, $z_{0}$ is the vertical
scale height, and $K_{1}$ is the modified Bessel function. The central surface brightness 
$\mu(0,0)$ is given by
\begin{equation}
\mu(0,0) \; = \;  2 \, h \, L_{0},
\end{equation}
where $L_{0}$ is the central luminosity \textit{density} (see \citealt{vdk81}). Note that 
$L_{0}$ is the actual parameter required by the function; $\mu(0,0)$ is calculated 
internally.

When $n = 1$, this becomes the familiar $\mathrm{sech}^2$ model for the
vertical distribution of a disk (with $z_{0}$ corresponding to $1/2$ of the
$z_0$ in the original definition of \citet{vdk81}). As $n \rightarrow \infty$,
the vertical distribution approaches an exponential with $\exp(-z/z_{0})$; in
practice, the can be approximated by setting $n$ equal to some fixed, large
number.

Note that this particular function requires that the \textsc{gnu} Scientific Library
(\textsc{gsl}) be installed; if the \textsc{gsl} is not installed, \imfit{} should be compiled
without this function. (The pre-compiled binary versions include the necessary
code from the \textsc{gsl}.)

\begin{verbatim}
FUNCTION EdgeOnDisk
PA
L_0
h
n
z_0
\end{verbatim}


\subsubsection{EdgeOnRing}

A simplistic model for an edge-on ring, using two offset components located
at distance $\pm$\texttt{r} from the center of the function block. Each component
(i.e., each side of the ring) is a symmetric Gaussian with size
\texttt{sigma\_r} for the radial profile and a symmetric Gaussian with
size \texttt{sigma\_z} for the vertical profile. (See GaussianRing3D for a similar
component which does line-of-sight integration through a 3D luminosity-density
model of a ring.)

\begin{verbatim}
FUNCTION EdgeOnRing
PA
I_0
r
sigma_r
sigma_z
\end{verbatim}


\subsubsection{EdgeOnRing2Side}

Similar to EdgeOnRing, but now the radial profile for the two components is
asymmetric: the inner ($|R| < R_{\mathrm{ring}}$) side of each component is a Gaussian
with radial size \texttt{sigma\_r\_in}, while the outer side has radial size
\texttt{sigma\_r\_out}.

\begin{verbatim}
FUNCTION EdgeOnRing2Side
PA
I_0
r
sigma_r_in
sigma_r_out
sigma_z
\end{verbatim}


\section{3D Functions}

The following are experimental image functions which use line-of-sight
integration through a 3D luminosity-density model to create a projected 2D
image.

The functions are defined so as to have a primary plane (e.g., the equatorial
plane for a disk galaxy); the orientation of this plane is defined by the
\texttt{PA} and \texttt{inc} parameters, which specify the angle of the line of
nodes (in degrees CCW with respect to the image +y axis) and the inclination to
the line of sight (also in degrees), respectively. Thus, \texttt{PA} $= 0$ will
align the line of nodes vertically, while \texttt{PA} $= 90$ will make it
horizontal (parallel to the image x-axis).\footnote{The goal is to ensure that
the orientation of the component's line of nodes follows the same conventions as
for the 2D functions, so that an inclined ExponentialDisk3D function with PA $=
30$ will have the same orientation as an elliptical 2D Exponential function with
PA $= 30$.} The inclination is defined in the usual astronomical sense: $i = 0$
for a face-on system and $i = 90$ for an edge-on system.

For the GaussianRing3D function, which is not axisymmetric, there is an
additional ``position angle'' parameter \texttt{PA\_ring}, which defines the position of the
ring's major axis \textit{in the primary plane} (i.e., prior to any projection)
with respect to the primary plane's +x axis. (The logic behind this is that when
the primary plane's line of nodes is \textit{horizontal} -- i.e., PA $= 90$ --
the orientation of the ring's major axis follows the usual orientation
conventions with respect to the image +y axis. You are, of course, free to
change this if you write 3D components of your own, though I will probably
continue to follow it in the future.)

These functions use integration routines from the \textsc{gnu} Scientific Library (\textsc{gsl});
if the \textsc{gsl} is not installed, \imfit{} should be compiled without them. (The
pre-compiled binary versions include the necessary code from the \textsc{gsl}.)


\subsubsection{ExponentialDisk3D}

This function implements a 3D luminosity density model for an axisymmetric
disk with an exponential radial profile and a ${\mathrm{sech}}^{2/n}$ vertical profile
(as for the EdgeOnDisk function), using line-of-sight integration to create the projected
surface-brightness profile for arbitrary inclinations.

In a cylindrical coordinate system $(r, z)$ aligned with the disk (where the disk
midplane has $z = 0$), the luminosity density at radius $r$ from 
the central axis and
at height $z$ from the midplane is given by
\begin{equation}
j(r,z) \; = \; J_{0} \; \exp(-r/h) \, {\mathrm{sech}}^{2/n} (n \, z/(2 \, z_{0}))
\end{equation}
where $h$ is the exponential scale length in the disk plane, $z_{0}$ is the vertical
scale height, and $J_{0}$ is the central luminosity density.

When $n = 1$, the vertical distribution is the familiar $\mathrm{sech}^2$ model
(with $z_{0}$ corresponding to $1/2$ of the $z_0$ in the original definition of
\citet{vdk81}). As $n \rightarrow \infty$, the vertical distribution approaches
an exponential with $\exp(-z/z_{0})$; in practice, the can be approximated by
setting $n$ equal to some fixed, large number.


\begin{verbatim}
FUNCTION ExponentialDisk3D
PA
inc
J_0
h
n
z_0
\end{verbatim}

Because this function performs numerical integration for each pixel value, it will be
slower than the analytic EdgeOnDisk function (though the latter is correct only in
the $i= 90\arcdeg$ case), and even slower than the standard Exponential function.



\subsubsection{BrokenExponentialDisk3D}

This function is similar to the ExponentialDisk3D function, except that the radial
profile of the luminosity density follows a broken-exponential profile (e.g., Section~\ref{})
instead of a simple exponential. Consequently, it has the following parameters:

\begin{verbatim}
FUNCTION BrokenExponentialDisk3D
PA
inc
J_0
h1
h2
r_break
alpha
n
z_0
\end{verbatim}




\subsubsection{GaussianRing3D}

Similar to ExponentialDisk3D, this function does line-of-sight integration
through an elliptical ring.  The ring is defined as having luminosity density
with a radial Gaussian profile (centered at \texttt{a\_ring} along ring's major
axis, with in-plane width $\sigma$) and a vertical exponential profile
(with scale height \texttt{h\_z}). The ring can be envisioned as residing in an
(invisible) plane which has a line of nodes at angle \texttt{PA} and inclination
\texttt{inc} (as for the ExponendialDisk3D function, above); within this plane,
the ring's major axis is at position angle \texttt{PA\_ring} \textit{relative to
the perpendicular to the line of nodes}, and the ring has an ellipticity given
by \texttt{ell}.

\begin{verbatim}
FUNCTION GaussianRing3D
PA
inc
PA_ring
ell
J_0
a_ring
sigma
h_z
\end{verbatim}





\chapter{Acknowledgments}

Major inspirations for \Imfit{} include both \textsc{galfit} \citep{peng02,peng10} and 
\textsc{budda} \citep{desouza04,gadotti08}.

Thanks also to Michael Opitsch and Michael Williams for being (partly unwitting)
beta testers and for their feedback, to Martin Kuemmel for suggestion
an improvement (and finding a related bug), to Roberto Saglia for urging me
to implement the Core-S{\'e}rsic function, and to Maximilian Fabricius for suggesting
improvements to the documentation.

\section{Data Sources}

Sample \textsc{fits} images for demonstration and testing use are taken from Data Release
7 \citep{abazajian09} of the Sloan Digital Sky Survey \citep{york00}. Funding
for the creation and distribution of the Sloan Digital Sky Survey Archive has been provided by the
Alfred P. Sloan Foundation, the Participating Institutions, the National
Aeronautics and Space Administration, the National Science Foundation, the U.S.
Department of Energy, the Japanese Monbukagakusho, and the Max Planck Society. 
The \textsc{sdss} Web site is \url{http://www.sdss.org/}.

The \textsc{sdss} is managed by the Astrophysical Research Consortium (\textsc{arc}) for
the Participating Institutions.  The Participating Institutions are
The University of Chicago, Fermilab, the Institute for Advanced Study,
the Japan Participation Group, The Johns Hopkins University, the
Korean Scientist Group, Los Alamos National Laboratory, the
Max-Planck-Institute for Astronomy (\textsc{mpia}), the Max-Planck-Institute
for Astrophysics (\textsc{mpa}), New Mexico State University, University of
Pittsburgh, University of Portsmouth, Princeton University, the United
States Naval Observatory, and the University of Washington.



\section{Specific Software Acknowledgments}

\subsubsection{Minpack}
This product includes software developed by the University of Chicago, as Operator of
the Argonne National Laboratory.



\bibliographystyle{plainnat}

\begin{thebibliography}{}


\bibitem[Abazajian et al.(2009)]{abazajian09} Abazajian, K. N.., et al.\ 2009, ``The Seventh 
Data Release of the Sloan Digital Sky Survey'', \textit{Astrophys.J. Supplement} \textbf{182}: 182

\bibitem[Athanassoula et al.(1990)]{athanassoula90} Athanassoula, E., Morin, S., Wozniak, H.,
Puy, D., Pierce, M. J., Lombard, J., \& Bosma, A. 1990, \textit{Monthly Notices of the Royal
Astronomical Society} \textbf{245}: 130.

\bibitem[Ciotti \& Bertin(1999)]{ciotti99} Ciotti, L., \& Bertin, G. 1999,
''Analytical properties of the R$^{1/m}$ law'', \textit{Astron.\ Astrophys.}
\textbf{352}: 447.

\bibitem[de Souza, Gadotti, \& dos Anjos(2004)]{desouza04} de Souza, R. E.,
Gadotti, D. A., \& dos Anjos, S. 2004, ``BUDDA: A New Two-dimensional Bulge/Disk
Decomposition Code for Detailed Structural Analysis of Galaxies'',
\textit{Astrophys.J. Supplement} \textbf{153}: 411.

\bibitem[Erwin, Pohlen, \& Beckman(2008)]{erwin08} Erwin, P.,
Pohlen, B., \& Beckman, J. E. 2008, ``The Outer Disks of Early-Type Galaxies. I. 
Surface-Brightness Profiles of Barred Galaxies'', \textit{Astron.J.} \textbf{135}: 20.

\bibitem[Erwin(2013)]{erwin13} Erwin, P. 2013, ``Imfit: A Fast, Flexible
New Program for Astronomical Image Fitting'', in prep.

\bibitem[Gadotti(2008)]{gadotti08} Gadotti, D. A. 2008, ``Image
decomposition of barred galaxies and AGN hosts'', \textit{Monthly
Notices of the Royal Astronomical Society} \textbf{384}: 420.

\bibitem[Graham et al.(2003)]{graham03} Graham, A., Erwin, P., Trujillo, I., \&
Asensio Ramos, A. 2003 ``A New Empirical Model for the Structural Analysis of
Early-Type Galaxies, and A Critical Review of the Nuker Model'',
\textit{Astron.J.} \textbf{125}: 2951

\bibitem[Humphrey, Liu, \& Buote(2009)]{humphrey09} Humphrey, P.~J.,
Liu, W., \& Buote, D.~A. 2009, ``{$\chi$}$^{2}$ and Poissonian Data:
Biases Even in the High-Count Regime and How to Avoid Them'',
\textit{Astrophys.J.} \textbf{693}: 822.

\bibitem[Krist(1995)]{krist95} Krist, J. 1995, ``Simulation of HST PSFs using
Tiny Tim'', in \textit{Astronomical Data Analysis Software and Systems IV}, R.A.
Shaw, H.E. Payne, and J.J.E. Hayes, eds., \textit{ASP Conference Series}
\textbf{77}: 349.

\bibitem[MacArthur, Courteau, \& Holtzman(2003)]{macarthur03} MacArthur, L. A.,
Courteau, S., \& Holtzman, J. A. 2003, ``Structure of Disk-dominated Galaxies.
I. Bulge/Disk Parameters, Simulations, and Secular Evolution'',
\textit{Astrophys.J.} \textbf{582}: 689.

\bibitem[Peng et al.(2002)]{peng02} Peng, C. Y., Ho, L. C., Impey, C. D., \&
Rix, H. W. 2002, ``Detailed Structural Decomposition of Galaxy Images'',
\textit{Astron.J.} \textbf{124}: 266

\bibitem[Peng et al.(2010)]{peng10} Peng, C. Y., Ho, L. C., Impey, C. D., \&
Rix, H. W. 2010, ``Detailed Decomposition of Galaxy Images. II. Beyond
Axisymmetric Models'', \textit{Astron.J.} \textbf{139}: 2097

\bibitem[S{\'e}rsic(1968)]{sersic68} S{\'e}rsic, J.-L. 1968, \textit{Atlas de 
Galaxias Australes} (Cordoba: Obs.\ Astron.)

\bibitem[Storn \& Price(1997)]{de} Storn, R. and Price, K. 1997, ``Differential
Evolution -- A Simple and Efficient Heuristic for Global Optimization Over
Continuous Spaces'', \textit{Journal of Global Optimization} \textbf{11}: 314

\bibitem[Trujillo et al.(2001)]{trujillo01} Trujillo, I., Aguerri, J. A. L.,
Cepa, J., \& Guti{\'e}rrez, C. M. 2001, ``The effects of seeing on S{\'e}rsic
profiles -- II. The Moffat PSF'', \textit{Monthly Notices of the Royal
Astronomical Society} \textbf{328}: 977.

\bibitem[Trujillo et al.(2004)]{trujillo04} Trujillo, I., Erwin, P., Asensio
Ramos, A., \& Graham, A. 2004, ``Evidence for a New Elliptical-Galaxy Paradigm:
S{\'e}rsic and Core Galaxies'', \textit{Astron.J.} \textbf{127}: 1917

\bibitem[van der Kruit \& Searle(1981)]{vdk81} van der Kruit, P. C., \&
Searle, L. 1981, ``Surface Photometry of Edge-on Spiral Galaxies: I. A
Model for the Three-dimensional Distribution of Light in Galactic
Disks'', \textit{Astron.\ Astrophys.} \textbf{95}: 105

\bibitem[van der Kruit(1988)]{vdk88} van der Kruit, P. 1988, ``The
Three-dimensional Distribution of Light and Mass in Disks of Spiral
Galaxies'', \textit{Astron.\ Astrophys.} \textbf{192}: 117

\bibitem[Yoachim \& Dalcanton(2006)]{yoachim06} Yoachim, P., \& Dalconton, J. J.
2006, ``Structural Parameters of Thin and Thick Disks in Edge-On Disk
Galaxies'', \textit{Astron.J.} \textbf{131}: 226

\bibitem[York et al.(2000)]{york00} York, D. G., et al.\ 2000, ``The Sloan Digital 
Sky Survey: Technical Summary'', \textit{Astron.J.} \textbf{120}: 1579


\end{thebibliography}
%\bibliography{imfit_howto}




\end{document}
